# workflow name
name: container build
# trigger on push events to main branch
on:
  push:
    branches: main

jobs:
  container-build:
    runs-on: ubuntu-latest
    # we need this, to be able to push to github container registry
    permissions:
      packages: write
    steps:
      # use a github marketplace action to checkout code
      - uses: actions/checkout@v2
      # login to github container registry with our push user and the autogenerated GITHUB_TOKEN
      # for more information, check https://docs.github.com/en/actions/security-guides/automatic-token-authentication
      - name: Login to DockerHub Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      # just a simple docker build with the triggered git SHA
      - name: build and tag container image
        run: docker build -t ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_SHA} -t ghcr.io/${GITHUB_REPOSITORY}:latest .
      # push the previously created container images
      - name: push container image
        run: |
          docker push ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_SHA}
          docker push ghcr.io/${GITHUB_REPOSITORY}:latest
